<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cierre Diario de Valores</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_globales/al_min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_globales/bustra_mind.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/estilos_globales/sweet_alerta2.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style_cierre_dia.css') }}">
</head>
<body>
    <div class="container py-4">
        <div class="dashboard-card">
            <div class="card-header-gradient">
                <div class="floating-action">
                    <button class="action-button" onclick="imprimirResumen()" title="Imprimir">
                        <i class="fas fa-print"></i>
                    </button>
                    <button class="action-button" onclick="guardarResumen()" title="Guardar">
                        <i class="fas fa-save"></i>
                    </button>
                </div>
                <h2 class="m-0">
                    <i class="fas fa-cash-register me-2"></i>
                    Cierre Diario de Valores
                </h2>
            </div>

            <div class="stats-container" id="dynamicStats">
                <!-- Las tarjetas se generarán dinámicamente aquí -->
            </div>
            

            <div class="chart-container">
                <canvas id="paymentsChart"></canvas>
            </div>

            <div class="table-container">
                <table class="custom-table">
                    <thead>
                        <tr>
                            <th>ID Venta</th>
                            <th>Total</th>
                            <th>Estado</th>
                            <th>Hora</th>
                        </tr>
                    </thead>
                    <tbody id="ventasTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
    </div>

    <script src="{{ url_for('static', filename='js/script_globales/chart.js') }}"></script>
    <script src="{{ url_for('static', filename='js/script_globales/sweet_alert2.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cierre_dia/cierre_de_dia.js') }}"></script>

    <script>
        let ventasData = [];
        let pagosPorMetodo = {
            Efectivo: 0,
            Transferencia: 0,
            CXC: 0
        };
        let chart = null;

        function mostrarCarga(mostrar = true) {
            document.getElementById('loadingOverlay').style.display = mostrar ? 'flex' : 'none';
        }

        function formatearPesos(valor) {
            return new Intl.NumberFormat('es-CL', {
                style: 'currency',
                currency: 'CLP'
            }).format(valor);
        }

        function actualizarEstadisticas() {
            document.getElementById('efectivoTotal').textContent = formatearPesos(pagosPorMetodo.Efectivo);
            document.getElementById('transferenciaTotal').textContent = formatearPesos(pagosPorMetodo.Transferencia);
            document.getElementById('cxcTotal').textContent = formatearPesos(pagosPorMetodo.CXC);
            
            const total = Object.values(pagosPorMetodo).reduce((a, b) => a + b, 0);
            document.getElementById('granTotal').textContent = formatearPesos(total);

            actualizarGrafico();
        }

        function actualizarGrafico() {
            const ctx = document.getElementById('paymentsChart').getContext('2d');
            
            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Efectivo', 'Transferencia', 'CXC'],
                    datasets: [{
                        data: [
                            pagosPorMetodo.Efectivo,
                            pagosPorMetodo.Transferencia,
                            pagosPorMetodo.CXC
                        ],
                        backgroundColor: [
                            '#22c55e',
                            '#3b82f6',
                            '#f59e0b'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        async function cargarDatos() {
            mostrarCarga();
            try {
                const response = await fetch('/api/ventas-y-pagos');
                const data = await response.json();
                
                if (data.length === 0) {
                    throw new Error('No hay datos disponibles');
                }

                const tableBody = document.getElementById('ventasTableBody');
                tableBody.innerHTML = '';
                
                let ventaActual = null;
                
                data.forEach(venta => {
                    if (ventaActual?.id !== venta[0]) {
                        ventaActual = {
                            id: venta[0],
                            total: venta[1],
                            hora: new Date().toLocaleTimeString()
                        };
                        
                        const row = tableBody.insertRow();
                        row.innerHTML = `
                            <td>${ventaActual.id}</td>
                            <td>${formatearPesos(ventaActual.total)}</td>
                            <td><span class="badge bg-success">Completada</span></td>
                            <td>${ventaActual.hora}</td>
                        `;
                        
                        ventasData.push(ventaActual);
                    }
                    
                    if (venta[2]) { // Si hay método de pago
                        pagosPorMetodo[venta[2]] += venta[3];
                    }
                });

                actualizarEstadisticas();
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudieron cargar los datos'
                });
            } finally {
                mostrarCarga(false);
            }
        }

        async function guardarResumen() {
            mostrarCarga();
            try {
                const data = {
                    fecha: new Date().toISOString().split('T')[0],
                    ventas: ventasData.map(v => v.id),
                    pagos: pagosPorMetodo,
                    total: Object.values(pagosPorMetodo).reduce((a, b) => a + b, 0)
                };

                const response = await fetch('/api/guardar-resumen', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error al guardar');

                await Swal.fire({
                    icon: 'success',
                    title: '¡Éxito!',
                    text: 'Resumen guardado correctamente',
                    showConfirmButton: false,
                    timer: 1500
                });

                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'No se pudo guardar el resumen'
                });
            } finally {
                mostrarCarga(false);
            }
        }

        function imprimirResumen() {
            window.print();
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', cargarDatos);
    </script>
</body>
</html>